<tui-loader
  [overlay]="true"
  [showLoader]="!!(selectClientes$ | async)?.loadingClientes"
>
<div >
  <!-- ================= BUSCADOR ================= -->
  <search tuiSearch class="py-2">
    <form [formGroup]="form" (submit)="onSubmitSearch()" class="flex">

      <fieldset tuiTextfieldSize="s" class="grid grid-cols-1 gap-2 mb-3">
        <tui-textfield iconStart="@tui.search">
          <input
            tuiTheme="ligth"
            tuiTextfield
            formControlName="text"
            placeholder="Buscar por nombre, correo, dirección, teléfono, DNI o RUC"
          />
        </tui-textfield>
      </fieldset>

      <div class="flex flex-col gap-2 mb-3">
        <div class="flex flex-wrap items-center gap-2 text-xs sm:text-sm">
          <span class="font-medium">
            Resultados:
            {{ isTheSearchWasDone ? allClientesSearch.length : allClientes.length }}
          </span>

          <div class="h-4 w-px bg-neutral-300 dark:bg-neutral-600 hidden sm:block"></div>

          <button
            tuiButton
            appearance="primary-grayscale"
            iconStart="@tui.rotate-cw"
            size="xs"
            type="reset"
            (click)="clearSearch()"
          >
            Limpiar {{ count() ? '(' + count() + ')' : '' }}
          </button>
        </div>

      
      </div>

    </form>
  </search>

  <!-- ================= CONTENEDOR ================= -->
  <div class=" ">

    <!-- ================= ESTADO VACÍO ================= -->
    <tui-block-status
      *ngIf="
        (selectClientes$ | async)?.clientes?.length === 0 &&
        !(selectClientes$ | async)?.loadingClientes;
        else tablaClientes
      "
      size="m"
      class="m-auto"
    >
      <img
        tuiSlot="top"
        alt="sin datos"
        src="https://res.cloudinary.com/ddksrkond/image/upload/v1743382501/APP%20INVENTARIO/undraw_no-data_ig65_k666oz.svg"
        class="w-56 mx-auto"
      />
      <h4>Aún no tienes ningún cliente</h4>
      <span>Empieza a crear clientes</span>
    </tui-block-status>

    <!-- ================= TABLA FAKE RESPONSIVE ================= -->
    <ng-template #tablaClientes>

      <!-- HEADER (solo desktop) -->
      <div
        class="
          hidden sm:grid
          grid-cols-[70px_2fr_1.5fr_2fr_2fr]
          py-3
          bg-neutral-100 dark:bg-neutral-800
          border border-neutral-200 dark:border-neutral-700
          pl-3
          text-xs font-semibold uppercase
          text-neutral-600 dark:text-neutral-300
        "
      >
        <div>ID</div>
        <div>Cliente</div>
        <div>Teléfono</div>
        <div>Email</div>
        <div>Dirección</div>
      </div>

      <!-- ========= CONTENEDOR CON SCROLL INFINITO ========= -->
      <div
        #scrollContainer
        class="
         
          rounded-lg sm:rounded-b-lg

          overflow-y-auto
        "
        style="max-height: 63vh;"
        infiniteScroll
        [infiniteScrollDistance]="2"       
        [infiniteScrollThrottle]="300"
        [scrollWindow]="true"
        [infiniteScrollContainer]="scrollContainer"
        (scrolled)="onScroll()"

        
        infiniteScroll
        
      >

        <!-- ROW -->
        <div
          *ngFor="let cliente of currentClientes; trackBy: trackByFn"
          class="
            grid grid-cols-1
            sm:grid-cols-[70px_2fr_1.5fr_2fr_2fr]
            gap-3 sm:gap-0
            px-4 py-4 sm:py-3
            bg-transparent
            transition
          "
        >

          <!-- ===== MOBILE CARD ===== -->
          <div class="flex items-center gap-3 sm:hidden">
            <tui-avatar size="m" src="@tui.user"></tui-avatar>
            <div>
              <div class="font-semibold text-sm">
                {{ cliente.fullname }}
              </div>
              <div class="text-xs text-neutral-500">
                #{{ cliente.id }}
              </div>
            </div>
          </div>

          <div class="sm:hidden text-sm">
            <span class="text-neutral-500">Teléfono:</span>
            <span>{{ cliente.phone || 'Sin teléfono' }}</span>
          </div>

          <div class="sm:hidden text-sm truncate">
            <span class="text-neutral-500">Email:</span>
            <span>{{ cliente.email || 'Sin correo' }}</span>
          </div>

          <div class="sm:hidden text-sm truncate">
            <span class="text-neutral-500">Dirección:</span>
            <span>{{ cliente.address || 'Sin dirección' }}</span>
          </div>

          <!-- ===== DESKTOP ===== -->
          <div class="hidden sm:flex items-center gap-2 text-sm">
            <tui-avatar size="s" src="@tui.user"></tui-avatar>
            <span>#{{ cliente.id }}</span>
          </div>

          <div class="hidden sm:block font-medium text-sm truncate">
            {{ cliente.fullname }}
          </div>

          <div class="hidden sm:block">
            <tui-chip
              *ngIf="cliente.phone; else sinTelefonoDesk"
              size="s"
              iconStart="@tui.phone"
              appearance="positive"
            >
              {{ cliente.phone }}
            </tui-chip>

            <ng-template #sinTelefonoDesk>
              <span class="text-xs text-neutral-500">Sin teléfono</span>
            </ng-template>
          </div>

          <div class="hidden sm:block text-sm text-neutral-600 dark:text-neutral-400 truncate">
            {{ cliente.email || 'Sin correo' }}
          </div>

          <div class="hidden sm:block text-sm text-neutral-600 dark:text-neutral-400 truncate">
            {{ cliente.address || 'Sin dirección' }}
          </div>

        </div>

        <!-- Loader -->
        <div *ngIf="loading" class="flex justify-center py-6">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
        </div>

        <!-- Fin -->
        <div
          *ngIf="!hasMore && !loading && currentClientes.length > 0"
          class="text-center text-xs text-neutral-500 py-4"
        >
          Has visto todos los clientes
        </div>

      </div>
    </ng-template>

  </div></div>
</tui-loader>
