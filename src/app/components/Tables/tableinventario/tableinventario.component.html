<section class="py-10  overflow-y-hidden" [tuiSkeleton]="!!(inventariosState$ | async)?.loadingProductosInventario">

  <!-- Caso 1: no hay inventarios y no se ha hecho búsqueda -->
  <tui-block-status *ngIf="!isTheSearchWasDone 
           && currentInventarios.length === 0
           && !(inventariosState$ | async)?.loadingProductosInventario; else contenido" 
           size="m" class="m-auto px-4">
    <img alt="no data"
      src="https://res.cloudinary.com/ddksrkond/image/upload/v1743382501/APP%20INVENTARIO/undraw_no-data_ig65_k666oz.svg"
      tuiSlot="top" class="max-w-[200px] sm:max-w-full mx-auto" />
    <h4 class="text-center text-sm sm:text-base">Aún no tienes ningún inventario</h4>
    <span class="text-center text-xs sm:text-sm">Empieza a crear un inventario</span>
  </tui-block-status>

  <ng-template #contenido>
    <!-- Buscador (FIJO, fuera del scroll) -->
    <search tuiSearch class="pb-4 sm:pb-6 px-4">
      <form [formGroup]="form" (submit)="onSubmitSearch()">
        <!-- Campos de búsqueda principales -->
        <fieldset tuiTextfieldSize="s" class="grid grid-cols-1 gap-2 sm:gap-3 mb-3 sm:mb-4">
          <tui-textfield iconStart="@tui.search" class="w-full">
            <input tuiTheme="ligth" formControlName="nombre" placeholder="Nombre o código" tuiTextfield />
          </tui-textfield>

          <div class=" w-full">
            <tui-select class="w-full" formControlName="categoria" [stringify]="stringify">
              Categoria
              <select placeholder="Categoria" tuiSelect [items]="(selectCategorias$ | async)"></select>
            </tui-select>

          </div>
        </fieldset>

        <!-- Resultados y controles -->
        <div class="flex flex-col gap-2 mb-3 sm:mb-4">
          <div class="flex flex-wrap gap-2 text-xs sm:text-sm">
            <span class="font-medium">
              Resultados: {{ isTheSearchWasDone ? allInventariosSearch.length : allInventarios.length }}
            </span>
            
            <div class="h-4 w-px bg-neutral-300 dark:bg-neutral-600 hidden sm:block"></div>
            
          
            <div class="h-4 w-px bg-neutral-300 dark:bg-neutral-600 hidden sm:block"></div>
            
            <button appearance="primary-grayscale" iconStart="@tui.rotate-cw" size="xs" tuiButton type="reset"
              (click)="clearSearch()" class="text-xs">
              Limpiar {{ count() ? '(' + count() + ')' : '' }}
            </button>
          </div>
        </div>

        <!-- Filtros expandibles
        <div >
          <div class="flex  gap-3 pb-3">
            <fieldset class="">
              <tui-input-range formControlName="stockRange">
                <label tuiLabel class="text-xs sm:text-sm">Rango de Stock</label>
              </tui-input-range>
            </fieldset>

            <fieldset class="">
              <tui-input-range formControlName="precioCompraRange">
                <label tuiLabel class="text-xs sm:text-sm">Rango Precio Compra</label>
              </tui-input-range>
            </fieldset>

            <fieldset class="">
              <tui-input-range formControlName="precioVentaRange">
                <label tuiLabel class="text-xs sm:text-sm">Rango Precio Venta</label>
              </tui-input-range>
            </fieldset>
          </div>
        </div>  -->
      </form>
    </search>

    <!-- CONTENEDOR CON SCROLL INFINITO -->
    <div #scrollContainer
      class="rounded-lg overflow-y-auto px-3 "
      style="max-height: 75vh;"
      [tuiSkeleton]="!!(inventariosState$ | async)?.loadingProductosInventario || !!(inventariosState$ | async)?.loadingDelete"
      infiniteScroll
      [infiniteScrollDistance]="2"
      [infiniteScrollThrottle]="300"
      [scrollWindow]="false"
      [infiniteScrollContainer]="scrollContainer"
      (scrolled)="onScroll()">

      <!-- Caso 2: mostrar contenido si hay inventarios -->
      <div *ngIf="currentInventarios.length > 0">
        
        <!-- Grid de Cards Moderno -->
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 sm:gap-6 px-2 sm:px-0 pb-4">
          <div *ngFor="let inventario of currentInventarios; trackBy: trackByFn"
            class="group bg-white dark:bg-neutral-800 rounded-2xl shadow-sm hover:shadow-xl transition-all duration-300 overflow-hidden border border-neutral-200 dark:border-neutral-700 hover:border-blue-400 dark:hover:border-blue-500">
            
            <!-- Imagen del producto -->
            <div class="relative aspect-square overflow-hidden bg-neutral-100 dark:bg-neutral-900"
              (click)="onSetImageProduct(inventario); open = true;">
              <img [src]="inventario?.imagen_producto ? URL_BASE + inventario.imagen_producto : 'https://sublimac.com/wp-content/uploads/2017/11/default-placeholder.png'"
                [alt]="inventario.producto_nombre"
                class="w-full h-full object-cover cursor-pointer group-hover:scale-110 transition-transform duration-300" />
              
              <!-- Badge de stock bajo -->
              <div *ngIf="inventario.cantidad <= 3" 
                class="absolute top-2 right-2 bg-red-500 text-white text-xs font-semibold px-2 py-1 rounded-full shadow-lg">
                Stock Bajo
              </div>
              
              <!-- Badge de estado -->
              <div *ngIf="!inventario.activo" 
                class="absolute top-2 left-2 bg-gray-500 text-white text-xs font-semibold px-2 py-1 rounded-full shadow-lg">
                Inactivo
              </div>
            </div>

            <!-- Contenido del card -->
            <div class="p-4">
              <!-- Nombre y SKU -->
              <div class="mb-3">
                <h3 class="font-semibold text-base mb-1 line-clamp-2 min-h-[2.5rem]">
                  {{ inventario.producto_nombre }}
                </h3>
                <p class="text-xs text-orange-600 dark:text-orange-400 mb-2" 
                  *ngIf="mostrarAdvertencia(inventario.producto_nombre)">
                  ⚠️ Producto eliminado
                </p>
                <tui-chip iconStart="@tui.scan-barcode" size="xs">
                  {{ inventario.producto_sku }}
                </tui-chip>
              </div>

              <!-- Categoría -->
              <div class="mb-3">
                <tui-badge appearance="neutral" size="m" tuiStatus>
                  {{ inventario.categoria_nombre }}
                </tui-badge>
              </div>

              <!-- Stock y Precio -->
              <div class="flex items-center justify-between mb-4 pb-3 border-b border-neutral-200 dark:border-neutral-700">
                <div>
                  <p class="text-xs text-neutral-600 dark:text-neutral-400 mb-1">Stock</p>
                  <p class="text-3xl font-bold" [ngClass]="getColorClass(inventario.cantidad)">
                    {{ inventario.cantidad }}
                  </p>
                </div>
                <div class="text-right">
                  <p class="text-xs text-neutral-600 dark:text-neutral-400 mb-1">Precio</p>
                  <p class="text-3xl font-bold text-blue-600 dark:text-blue-400">
                    S/. {{ inventario.costo_venta }}
                  </p>
                  <p class="text-xs text-red-400" *ngIf="inventario.costo_venta == 0">Sin costo</p>
                </div>
              </div>

              <!-- Advertencias -->
              <div class="mb-3" *ngIf="inventario.cantidad <= 0 || inventario.costo_venta <= 0 || !inventario.activo">
                <div class="flex items-center gap-2 p-2 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg text-xs">
                  <span class="text-yellow-600 dark:text-yellow-400">⚠️</span>
                  <span class="text-yellow-700 dark:text-yellow-300">
                    <span *ngIf="inventario.cantidad <= 0">Sin stock</span>
                    <span *ngIf="inventario.cantidad > 0 && inventario.costo_venta <= 0"> Sin precio</span>
                    <span *ngIf="!inventario.activo"> Inactivo</span>
                  </span>
                </div>
              </div>

              <!-- Botones de acción - Modo Normal -->
              <div class="grid grid-cols-2 gap-2" *ngIf="mode === 'normal'">
                <button [disabled]="!!!(userPermissions$ | async)?.can_delete_inventory"
                  [appearance]="!!(userPermissions$ | async)?.can_delete_inventory ? 'error':'secondary-neutralscale'"
                  (click)="eliminarInventario(inventario.id)" iconStart="@tui.trash" tuiButton
                  type="button" size="s" class="w-full text-xs">
                  Eliminar
                </button>
                
                <button appearance="info" [disabled]="!inventario.activo"
                  (click)="showDialogEditInventario(inventario)" iconStart="@tui.pencil" tuiButton type="button"
                  size="s" class="w-full text-xs">
                  Editar
                </button>
              </div>

              <!-- Botones de acción - Modo Selección -->
              <div *ngIf="mode === 'select_product_sale_mode'">
                <button [disabled]="inventario.cantidad <= 0 || !inventario.activo || inventario.costo_venta <= 0"
                  [appearance]="inventario.cantidad <= 0 || inventario.costo_venta <= 0 || !inventario.activo ? 'secondary-grayscale': 'primary-grayscale'" 
                  class="w-full"
                  (click)="cerrarDialogo(inventario)"
                  [iconStart]="inventario.cantidad <= 0 || inventario.costo_venta <= 0 ? '@tui.lock': '@tui.plus'" 
                  tuiButton type="button" size="m">
                  {{ inventario.cantidad <= 0 || inventario.costo_venta <= 0 || !inventario.activo ? 'No disponible' : 'Agregar' }}
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Indicador de carga al hacer scroll -->
        <div *ngIf="loading" class="flex justify-center items-center py-8">
          <div class="flex flex-col items-center gap-3">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            <p class="text-sm text-neutral-600 dark:text-neutral-400">Cargando más productos...</p>
          </div>
        </div>

        <!-- Mensaje cuando no hay más items para cargar -->
        <div *ngIf="!hasMore && !loading && currentInventarios.length > 0" 
          class="text-center py-6 border-t border-neutral-200 dark:border-neutral-700">
          <div class="flex flex-col items-center gap-2">
            <svg class="w-10 h-10 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <p class="text-sm font-medium text-neutral-700 dark:text-neutral-300">
              Has visto todos los productos
            </p>
            <p class="text-xs text-neutral-500 dark:text-neutral-400">
              Total: {{ isTheSearchWasDone ? allInventariosSearch.length : allInventarios.length }} productos
            </p>
          </div>
        </div>

        <!-- Contador de productos visibles -->
        <div *ngIf="hasMore && currentInventarios.length > 0" 
          class="text-center py-4 text-xs text-neutral-400 dark:text-neutral-500 sticky bottom-0 bg-white/80 dark:bg-neutral-900/80 backdrop-blur-sm">
          <p>
            Mostrando <span class="font-semibold">{{ currentInventarios.length }}</span> 
            de 
            <span class="font-semibold">{{ isTheSearchWasDone ? allInventariosSearch.length : allInventarios.length }}</span> 
            productos
          </p>
        </div>

      </div>

      <!-- Caso 3: búsqueda hecha pero sin resultados -->
      <tui-block-status *ngIf="isTheSearchWasDone 
               && currentInventarios.length === 0
               && !(inventariosState$ | async)?.loadingProductosInventario" 
               size="m" class="m-auto px-4 py-8">
        <img alt="no matches"
          src="https://res.cloudinary.com/ddksrkond/image/upload/v1743382501/APP%20INVENTARIO/undraw_no-data_ig65_k666oz.svg"
          tuiSlot="top" class="max-w-[200px] sm:max-w-full mx-auto" />
        <h4 class="text-center text-sm sm:text-base">Productos no encontrados en el inventario</h4>
        <span class="text-center text-xs sm:text-sm">No coincidimos con ningún producto</span>
      </tui-block-status>

    </div>
  </ng-template>

</section>

<!-- Modal de preview responsive -->
<ng-template [(tuiPreviewDialog)]="open">
  <tui-preview>
    <tui-preview-title class="text-sm sm:text-base px-4">{{ titles[index] }}</tui-preview-title>
    <tui-preview-pagination [length]="length" [(index)]="index" />

    <button iconStart="@tui.x" tuiIconButton tuiPreviewAction type="button" (click)="open = false"
      class="text-sm sm:text-base">
      Close
    </button>

    <img *polymorpheusOutlet="content[index] as src" alt="preview" [src]="src" 
      class="w-full h-auto max-h-[70vh] sm:max-h-[80vh] object-contain p-2 sm:p-4" />
  </tui-preview>
</ng-template>