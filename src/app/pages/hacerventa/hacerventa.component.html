<div class="flex flex-col ">

    <tui-loader [showLoader]="loaderSearchCliente || (loadingCreateVenta$ | async)?.loadingCreateVenta"
        [overlay]="true">


        <form [formGroup]="ventaForm" class="h-full">
            <!-- Header con información de la venta -->
            <div class=" border-b border-neutral-200 dark:border-neutral-700 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div>
                            <h1 class="text-2xl font-bold text-neutral-900 dark:text-white">Nueva Venta</h1>
                            <p class="text-sm text-neutral-500 dark:text-neutral-400">Sistema de punto de venta</p>
                        </div>

                    </div>
                    <div class="flex items-center gap-3">
                        <tui-select formControlName="tipoComprobante" class="w-40">
                            Comprobante
                            <tui-data-list *tuiDataList>
                                <button [disabled]="!(userPermissions$ | async)?.can_make_sale"
                                    *ngFor="let comprobante of tipoComprobantes" tuiOption [value]="comprobante">
                                    {{ comprobante }}
                                </button>
                            </tui-data-list>
                        </tui-select>

                        <tui-select formControlName="metodoPago" class="w-40">
                            Método
                            <tui-data-list *tuiDataList>
                                <button [disabled]="!(userPermissions$ | async)?.can_make_sale"
                                    *ngFor="let metodo of listMetodosPago" tuiOption [value]="metodo">
                                    {{ metodo }}
                                </button>
                            </tui-data-list>
                        </tui-select>

                        <tui-select formControlName="formaPago" class="w-40">
                            Forma
                            <tui-data-list *tuiDataList>
                                <button [disabled]="!(userPermissions$ | async)?.can_make_sale"
                                    *ngFor="let pago of formasPago" tuiOption [value]="pago">
                                    {{ pago }}
                                </button>
                            </tui-data-list>
                        </tui-select>
                    </div>
                </div>
            </div>
            <!-- <app-barcode-scanner (barcodeScanned)="onBarcodeScanned($event)">
            </app-barcode-scanner>-->
            <!-- Contenido principal -->
            <div class="grid grid-cols-1 lg:grid-cols-[1fr_400px] gap-0 h-[calc(100vh-180px)]">
<div class="p-4">
 <!-- Área de productos (izquierda) -->
                <div class="p-6 overflow-y-auto border-2 border-dashed rounded-xl"   #containerAreaProducts tabindex="0" (click)="clickedInside()">

                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold text-neutral-900 dark:text-white">
                            Productos en agregados ({{ productosFormArray.length }})
                        </h2>
                        <button iconStart="@tui.plus" tuiButtonVertical tuiButton appearance="primary-grayscale"
                            type="button" (click)="showDialog()">
                            Agregar
                        </button>
                    </div>

                    <!-- Lista de productos -->
                    <div class="space-y-2  rounded-lg p-4   focus:outline-none transition-colors cursor-pointer"
                      >
                        <!-- Contenedor del input oculto para detector de código de barras -->
                      


                        <div *ngFor="let item of productosFormArray.controls; let i = index" [formGroup]="item"
                            class="bg-neutral-50 dark:bg-neutral-800 rounded-lg p-4 flex items-center justify-between  transition-colors">

                            <div class="flex items-center gap-4 flex-1">
                                <!-- imagen -->
                                <div class="flex justify-left items-left py-2">
                                    <div
                                        class="w-24 h-24 rounded-xl overflow-hidden border-2 border-gray-300 dark:border-gray-600 shadow-md hover:shadow-xl transition-all hover:border-blue-500 dark:hover:border-blue-400">
                                        <img [src]="item.get('imagen_producto')?.value" alt="Imagen del producto"
                                            class="w-full h-full object-cover" />
                                    </div>
                                </div>

                                <div class="flex flex-col input-select-cantidad  ">


                                    <tui-select formControlName="cantidad_final" class="w-24" tuiTextfieldSize="l">

                                        <tui-data-list *tuiDataList>
                                            <button *ngFor="let cantidad of arrayCantidades" class="text-md" tuiOption
                                                type="button" [value]="cantidad">
                                                {{ cantidad }}
                                            </button>
                                        </tui-data-list>
                                    </tui-select>


                                </div>


                                <!-- Info producto -->
                                <div class="flex-1">
                                    <p class="font-semibold text-xl text-neutral-900 dark:text-white">
                                        {{ item.get('producto_sku')?.value }} -
                                        {{ item.get('producto_nombre')?.value }}
                                    </p>
                                    <p class="text-sm text-neutral-500 dark:text-neutral-400">
                                        {{ item.get('nombre_categoria')?.value }}
                                    </p>


                                </div>

                                <!-- Precio -->
                                <div class="text-right">
                                    <p class="text-2xl font-bold text-black dark:text-white">
                                        {{ ((+item.get('costo_venta')?.value || 0) * (+item.get('cantidad_final')?.value
                                        || 0)) | tuiAmount: 'S/.' : 'left' | async }}

                                    </p>
                                </div>

                                <!-- Eliminar -->
                                <button tuiIconButton appearance="negative" iconStart="@tui.trash" type="button"
                                    (click)="eliminarProductoForm(i)" size="xl">
                                </button>
                            </div>
                        </div>

                        <!-- Estado vacío -->
                        <div *ngIf="productosFormArray.length === 0"
                            class="text-center py-16 text-neutral-400  dark:text-neutral-300  rounded-lg">
                            <img class="pb-8 w-36 h-36 object-contain text-center mx-auto"
                                src="https://cdn-icons-png.flaticon.com/512/10951/10951882.png" alt="">
                            <p class="text-2xl font-bold">No hay productos en el carrito</p>
                            <p class="text-md">Presiona "Agregar Producto" o Escanea con el código de barras.</p>
                        </div>
                    </div>
                </div>
</div>
               

                <!-- Panel lateral derecho (Resumen y cliente) -->
                <div
                    class="bg-neutral-100 dark:bg-neutral-800 p-6 flex flex-col border-l border-neutral-200 dark:border-neutral-700">

                    <!-- Información del cliente -->
                    <div class="bg-white dark:bg-neutral-800 rounded-lg p-4 ">
                        <h3 class="text-sm font-semibold text-neutral-700 dark:text-neutral-300 mb-3">
                            INFORMACIÓN DEL CLIENTE
                        </h3>

                        <div *ngIf="ventaForm.get('tipoComprobante')?.value !== 'Anonima'" class="space-y-3">
                            <!-- Búsqueda de cliente -->
                            <div *ngIf="!ventaForm.get('cliente')?.value" class="flex gap-2">
                                <tui-input [disabled]="!(userPermissions$ | async)?.can_make_sale" class="flex-1"
                                    formControlName="documento_cliente">
                                    {{ ventaForm.get('tipoComprobante')?.value === 'Boleta' ? 'DNI' : 'RUC' }}
                                    <input
                                        [placeholder]="ventaForm.get('tipoComprobante')?.value === 'Boleta' ? 'DNI' : 'RUC'"
                                        tuiTextfieldLegacy size="s" type="text" />
                                </tui-input>
                                <button tuiIconButton iconStart="@tui.search" type="button"
                                    appearance="primary-grayscale" (click)="buscarCliente()"
                                    [disabled]="ventaForm.get('documento_cliente')?.invalid || !(userPermissions$ | async)?.can_make_sale">
                                </button>
                            </div>

                            <!-- Cliente encontrado -->
                            <div *ngIf="ventaForm.get('cliente')?.value"
                                class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-3">
                                <div class="flex items-start justify-between mb-2">
                                    <div class="flex-1">
                                        <p class="font-semibold text-neutral-900 dark:text-white">
                                            {{ ventaForm.get('nombre_cliente')?.value }}
                                        </p>
                                        <p class="text-sm text-neutral-600 dark:text-neutral-400">
                                            {{ ventaForm.get('documento_cliente')?.value }}
                                        </p>
                                    </div>
                                    <button tuiIconButton iconStart="@tui.x" type="button" size="xs" appearance="flat"
                                        (click)="borrarCliente()">
                                    </button>
                                </div>
                                <div>


                                    <span
                                        class="text-xs text-blue-600 dark:text-blue-400 cursor-pointer hover:underline"
                                        (click)="expanded = !expanded">
                                        {{ expanded ? '− Ocultar detalles' : 'Actualizar informacion adicional' }}
                                    </span>
                                </div>
                            </div>

                            <!-- Detalles expandibles -->
                            <div [@expandCollapse]="expanded ? 'open' : 'closed'" class="overflow-hidden">
                                <div class="space-y-2 pt-2">
                                    <tui-textfield class="w-full">
                                        <input tuiTextfield size="s" formControlName="direccion_cliente"
                                            placeholder="Dirección" />
                                    </tui-textfield>
                                    <tui-textfield class="w-full">
                                        <input tuiTextfield size="s" type="email" formControlName="correo_cliente"
                                            placeholder="Correo electrónico" />
                                    </tui-textfield>
                                    <tui-textfield class="w-full">
                                        <input tuiTextfield size="s" formControlName="telefono_cliente"
                                            placeholder="Teléfono" />
                                    </tui-textfield>
                                </div>
                            </div>

                            <span *ngIf="errorClientNotFound" class="text-red-500 text-xs">
                                ⚠ Cliente no encontrado. Intente más tarde.
                            </span>



                        </div>
                        <div *ngIf="ventaForm.get('tipoComprobante')?.value === 'Anonima'"
                            class="text-center py-4 text-neutral-500 dark:text-neutral-400">
                            <p class="text-sm">Venta anónima - Sin datos de cliente</p>
                        </div>
                    </div>

                    <label class="flex items-center gap-2 text-sm pl-4">
                        <input [disabled]="!(userPermissions$ | async)?.can_make_sale" tuiCheckbox type="checkbox"
                            formControlName="is_send_sunat" [size]="'m'" />
                        Enviar a SUNAT
                    </label>


                    <!-- Resumen de totales -->
                    <div class="bg-white dark:bg-neutral-800 rounded-lg p-4 mb-4 flex-1">
                        <h3 class="text-sm font-semibold text-neutral-700 dark:text-neutral-300 mb-3">
                            RESUMEN
                        </h3>
                        <div class="space-y-3">
                            <div class="flex justify-between text-neutral-600 dark:text-neutral-400">
                                <span>Subtotal</span>
                                <span>{{ salesTotals.subtotal | currency:'S/' }}</span>
                            </div>
                            <div class="flex justify-between text-neutral-600 dark:text-neutral-400">
                                <span>IGV (18%)</span>
                                <span>{{ salesTotals.igv | currency:'S/' }}</span>
                            </div>
                            <div class="border-t border-neutral-200 dark:border-neutral-700 pt-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-lg font-semibold text-neutral-900 dark:text-white">Total</span>
                                    <span class="text-4xl font-bold text-black dark:text-white">
                                        {{ salesTotals.total | currency:'S/' }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Advertencia de permisos -->
                    <div *ngIf="!(userPermissions$ | async)?.can_make_sale"
                        class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-3 mb-4">
                        <p class="text-sm text-yellow-800 dark:text-yellow-200">
                            ⚠ Permisos insuficientes para realizar ventas
                        </p>
                    </div>

                    <!-- Botón de finalizar venta -->
                    <div *ngIf="(userPermissions$ | async)?.can_make_sale">
                        <button *ngIf="ventaForm.get('tipoComprobante')?.value !== 'Anonima'"
                            [disabled]="!ventaForm.valid || ventaForm.get('productos')?.value.length === 0"
                            class="w-full" tuiButton type="submit" (click)="hacerVenta()" appearance="primary-grayscale"
                            size="l">
                            <span class="flex items-center justify-center gap-2">

                                <span>Finalizar Venta</span>
                            </span>
                        </button>

                        <button *ngIf="ventaForm.get('tipoComprobante')?.value === 'Anonima'"
                            [disabled]="ventaForm.get('productos')?.value.length === 0" class="w-full" tuiButton
                            type="submit" (click)="hacerVenta()" appearance="primary-grayscale" size="l">
                            <span class="flex items-center justify-center gap-2">
                                <span class="text-lg"></span>
                                <span>Finalizar Venta Anónima</span>
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </tui-loader>
</div>