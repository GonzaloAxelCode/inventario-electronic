<div class="flex flex-col ">
    <tui-loader [showLoader]="loaderSearchCliente || (loadingCreateVenta$ | async)?.loadingCreateVenta"
        [overlay]="true">
        
     <app-barcode-scanner 
    (barcodeScanned)="onBarcodeScanned($event)">
  </app-barcode-scanner>
        <form [formGroup]="ventaForm" class="h-full">
            <!-- Header con informaciÃ³n de la venta -->
            <div class=" border-b border-neutral-200 dark:border-neutral-700 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div>
                            <h1 class="text-2xl font-bold text-neutral-900 dark:text-white">Nueva Venta</h1>
                            <p class="text-sm text-neutral-500 dark:text-neutral-400">Sistema de punto de venta</p>
                        </div>
                       
                    </div>
                    <div class="flex items-center gap-3">
                        <tui-select formControlName="tipoComprobante" class="w-40">
                            Comprobante
                            <tui-data-list *tuiDataList>
                                <button [disabled]="!(userPermissions$ | async)?.can_make_sale"
                                    *ngFor="let comprobante of tipoComprobantes" tuiOption [value]="comprobante">
                                    {{ comprobante }}
                                </button>
                            </tui-data-list>
                        </tui-select>

                        <tui-select formControlName="metodoPago" class="w-40">
                            MÃ©todo
                            <tui-data-list *tuiDataList>
                                <button [disabled]="!(userPermissions$ | async)?.can_make_sale"
                                    *ngFor="let metodo of listMetodosPago" tuiOption [value]="metodo">
                                    {{ metodo }}
                                </button>
                            </tui-data-list>
                        </tui-select>

                        <tui-select formControlName="formaPago" class="w-40">
                            Forma
                            <tui-data-list *tuiDataList>
                                <button [disabled]="!(userPermissions$ | async)?.can_make_sale"
                                    *ngFor="let pago of formasPago" tuiOption [value]="pago">
                                    {{ pago }}
                                </button>
                            </tui-data-list>
                        </tui-select>
                    </div>
                </div>
            </div>

            <!-- Contenido principal -->
            <div class="grid grid-cols-1 lg:grid-cols-[1fr_400px] gap-0 h-[calc(100vh-180px)]">
                
                <!-- Ãrea de productos (izquierda) -->
                <div class="p-6 overflow-y-auto">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold text-neutral-900 dark:text-white">
                            Productos en carrito ({{ productosFormArray.length }})
                        </h2>
                        <button 
                         iconStart="@tui.plus"
                          tuiButtonVertical tuiButton appearance="primary-grayscale" type="button"
                            (click)="showDialog()">
                            Agregar 
                        </button>
                    </div>

                    <!-- Lista de productos -->
                    <div class="space-y-2">
                        <!-- Contenedor del input oculto para detector de cÃ³digo de barras -->
                        
                    

 
                        <div *ngFor="let item of productosFormArray.controls; let i = index" [formGroup]="item"
                            class="bg-neutral-50 dark:bg-neutral-700 rounded-lg p-4 flex items-center justify-between hover:bg-neutral-100 dark:hover:bg-neutral-600 transition-colors">
                            
                            <div class="flex items-center gap-4 flex-1">
                                <!-- Cantidad -->
                        <img  alt="">
                         <div  class="text-left">
                <div class="flex justify-left items-left py-2">
                  <div
                    class="w-24 h-24 rounded-xl overflow-hidden border-2 border-gray-300 dark:border-gray-600 shadow-md hover:shadow-xl transition-all hover:border-blue-500 dark:hover:border-blue-400">
                    <img src="{{ item.get('imagen_producto')?.value }}"
                    
                      class="w-full h-full object-cover cursor-pointer hover:scale-110 transition-transform duration-200" />

                  </div>
                </div>
              </div>
              
                                <div class="flex items-center gap-2">
                                    <tui-select formControlName="cantidad_final" class="w-20" tuiTextfieldSize="s">
                                        <tui-data-list *tuiDataList>
                                            <button *ngFor="let cantidad of arrayCantidades" tuiOption type="button"
                                                [value]="cantidad">
                                                {{ cantidad }}
                                            </button>
                                        </tui-data-list>
                                    </tui-select>
                                    <span class="text-neutral-500 dark:text-neutral-400">Ã—</span>
                                </div>

                                <!-- Info producto -->
                                <div class="flex-1">
                                    <p class="font-semibold text-xl text-neutral-900 dark:text-white">
                                        {{ item.get('producto_sku')?.value }} - 
                                        {{ item.get('producto_nombre')?.value }}
                                    </p>
                                    <p class="text-sm text-neutral-500 dark:text-neutral-400">
                                        {{ item.get('nombre_categoria')?.value }}
                                    </p>


                                </div>

                                <!-- Precio -->
                                <div class="text-right">
                                    <p class="text-xl font-bold text-black dark:text-white">
                                        {{ item.get('costo_venta')?.value | tuiAmount: 'S/.' : 'left' | async }}
                                    </p>
                                </div>

                                <!-- Eliminar -->
                                <button appearance="flat" tuiIconButton iconStart="@tui.trash" type="button"
                                    (click)="eliminarProductoForm(i)" size="s">
                                </button>
                            </div>
                        </div>

                        <!-- Estado vacÃ­o -->
                        <div *ngIf="productosFormArray.length === 0" 
                            class="text-center py-16 text-neutral-400 dark:text-neutral-500">
                            <p class="text-lg mb-2">ðŸ›’</p>
                            <p>No hay productos en el carrito</p>
                            <p class="text-sm">Presiona "Agregar Producto" para comenzar</p>
                        </div>
                    </div>
                </div>

                <!-- Panel lateral derecho (Resumen y cliente) -->
                <div class="bg-neutral-100 dark:bg-neutral-800 p-6 flex flex-col border-l border-neutral-200 dark:border-neutral-700">
                    
                    <!-- InformaciÃ³n del cliente -->
                    <div class="bg-white dark:bg-neutral-800 rounded-lg p-4 mb-4">
                        <h3 class="text-sm font-semibold text-neutral-700 dark:text-neutral-300 mb-3">
                            INFORMACIÃ“N DEL CLIENTE
                        </h3>

                        <div *ngIf="ventaForm.get('tipoComprobante')?.value !== 'Anonima'" class="space-y-3">
                            <!-- BÃºsqueda de cliente -->
                            <div *ngIf="!ventaForm.get('cliente')?.value" class="flex gap-2">
                                <tui-input [disabled]="!(userPermissions$ | async)?.can_make_sale" 
                                    class="flex-1" formControlName="documento_cliente">
                                    {{ ventaForm.get('tipoComprobante')?.value === 'Boleta' ? 'DNI' : 'RUC' }}
                                    <input [placeholder]="ventaForm.get('tipoComprobante')?.value === 'Boleta' ? 'DNI' : 'RUC'"
                                        tuiTextfieldLegacy size="s" type="text" />
                                </tui-input>
                                <button tuiIconButton iconStart="@tui.search" type="button"
                                    appearance="primary-grayscale" (click)="buscarCliente()"
                                    [disabled]="ventaForm.get('documento_cliente')?.invalid || !(userPermissions$ | async)?.can_make_sale">
                                </button>
                            </div>

                            <!-- Cliente encontrado -->
                            <div *ngIf="ventaForm.get('cliente')?.value" 
                                class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-3">
                                <div class="flex items-start justify-between mb-2">
                                    <div class="flex-1">
                                        <p class="font-semibold text-neutral-900 dark:text-white">
                                            {{ ventaForm.get('nombre_cliente')?.value }}
                                        </p>
                                        <p class="text-sm text-neutral-600 dark:text-neutral-400">
                                            {{ ventaForm.get('documento_cliente')?.value }}
                                        </p>
                                    </div>
                                    <button tuiIconButton  iconStart="@tui.x" type="button" size="xs"
                                        appearance="flat" (click)="borrarCliente()">
                                    </button>
                                </div>
                                <div   >


                                <span class="text-xs text-blue-600 dark:text-blue-400 cursor-pointer hover:underline"
                                    (click)="expanded = !expanded">
                                    {{ expanded ? 'âˆ’ Ocultar detalles' : '+ Cliente nuevo, agregar informacion' }}
                                </span>
                                                                </div>
                            </div>

                            <!-- Detalles expandibles -->
                            <div [@expandCollapse]="expanded ? 'open' : 'closed'" class="overflow-hidden">
                                <div class="space-y-2 pt-2">
                                    <tui-textfield class="w-full">
                                        <input tuiTextfield size="s" formControlName="direccion_cliente" 
                                            placeholder="DirecciÃ³n" />
                                    </tui-textfield>
                                    <tui-textfield class="w-full">
                                        <input tuiTextfield size="s" type="email" formControlName="correo_cliente" 
                                            placeholder="Correo electrÃ³nico" />
                                    </tui-textfield>
                                    <tui-textfield class="w-full">
                                        <input tuiTextfield size="s" formControlName="telefono_cliente" 
                                            placeholder="TelÃ©fono" />
                                    </tui-textfield>
                                </div>
                            </div>

                            <span *ngIf="errorClientNotFound" class="text-red-500 text-xs">
                                âš  Cliente no encontrado. Intente mÃ¡s tarde.
                            </span>

                            <label class="flex items-center gap-2 text-sm">
                                <input [disabled]="!(userPermissions$ | async)?.can_make_sale" 
                                    tuiCheckbox type="checkbox" formControlName="is_send_sunat" [size]="'s'" />
                                Enviar a SUNAT
                            </label>
                          
                        </div>

                        <div *ngIf="ventaForm.get('tipoComprobante')?.value === 'Anonima'" 
                            class="text-center py-4 text-neutral-500 dark:text-neutral-400">
                            <p class="text-sm">Venta anÃ³nima - Sin datos de cliente</p>
                        </div>
                    </div>


                    <!-- Resumen de totales -->
                    <div class="bg-white dark:bg-neutral-800 rounded-lg p-4 mb-4 flex-1">
                        <h3 class="text-sm font-semibold text-neutral-700 dark:text-neutral-300 mb-3">
                            RESUMEN
                        </h3>
                        <div class="space-y-3">
                            <div class="flex justify-between text-neutral-600 dark:text-neutral-400">
                                <span>Subtotal</span>
                                <span>{{ salesTotals.subtotal | currency:'S/' }}</span>
                            </div>
                            <div class="flex justify-between text-neutral-600 dark:text-neutral-400">
                                <span>IGV (18%)</span>
                                <span>{{ salesTotals.igv | currency:'S/' }}</span>
                            </div>
                            <div class="border-t border-neutral-200 dark:border-neutral-700 pt-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-lg font-semibold text-neutral-900 dark:text-white">Total</span>
                                    <span class="text-4xl font-bold text-black dark:text-white">
                                        {{ salesTotals.total | currency:'S/' }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Advertencia de permisos -->
                    <div *ngIf="!(userPermissions$ | async)?.can_make_sale" 
                        class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-3 mb-4">
                        <p class="text-sm text-yellow-800 dark:text-yellow-200">
                            âš  Permisos insuficientes para realizar ventas
                        </p>
                    </div>

                    <!-- BotÃ³n de finalizar venta -->
                    <div *ngIf="(userPermissions$ | async)?.can_make_sale">
                        <button *ngIf="ventaForm.get('tipoComprobante')?.value !== 'Anonima'"
                            [disabled]="!ventaForm.valid || ventaForm.get('productos')?.value.length === 0"
                            class="w-full" tuiButton 
                            type="submit" 
                            (click)="hacerVenta()" 
                            appearance="primary-grayscale" size="l">
                            <span class="flex items-center justify-center gap-2">
                                
                                <span>Finalizar Venta</span>
                            </span>
                        </button>

                        <button *ngIf="ventaForm.get('tipoComprobante')?.value === 'Anonima'"
                            [disabled]="ventaForm.get('productos')?.value.length === 0"
                            class="w-full" tuiButton type="submit" (click)="hacerVenta()" 
                            appearance="primary" size="l">
                            <span class="flex items-center justify-center gap-2">
                                <span class="text-lg">ðŸ’³</span>
                                <span>Finalizar Venta AnÃ³nima</span>
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </tui-loader>
</div>