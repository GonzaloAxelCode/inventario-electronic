<main tuiNavigationMain class="h-screen">
  <header tuiSubheader>
    <div class="flex gap-4 pt-4 items-center">
      <h2 tuiHeader>
        <div tuiTitle>
          <div tuiNavigationLogo>
            <tui-icon icon="@tui.gitlab" />
            <span tuiFade>Gestion de Ventas</span>
          </div>


        </div>
      </h2>
    </div>


    <!-- PESTAÑAS SIN ROUTER -->
    <nav tuiTabs class="flex gap-2 overflow-x-auto whitespace-nowrap py-2 px-1">

      <button tuiTab (click)="setTab('historial')" [class.active-link]="activeTab === 'historial'">
        Historial de Ventas
      </button>

      <button tuiTab (click)="setTab('ventas-hoy')" [class.active-link]="activeTab === 'ventas-hoy'">
        Ventas Hoy
      </button>

      <button tuiTab (click)="setTab('ultima-venta')" [class.active-link]="activeTab === 'ultima-venta'">
        Ver última venta realizada
      </button>

      <button tuiTab (click)="setTab('anuladas-hoy')" [class.active-link]="activeTab === 'anuladas-hoy'">
        Ventas Anuladas Hoy
      </button>

      <button tuiTab (click)="setTab('top-productos-hoy')" [class.active-link]="activeTab === 'top-productos-hoy'">
        Productos más vendidos Hoy
      </button>

    </nav>
  </header>
  <div>
    <div class="py-4">


      <ng-container *ngIf="activeTab === 'historial'">

        <div class="p-4 md:p-6">
          <div class="flex gap-2">
          </div>

          <section [tuiSkeleton]="!!(ventasState$ | async)?.loadingLoadVentas">
            <div
              *ngIf="(ventasState$ | async)?.ventas?.length === 0 && !(ventasState$ | async)?.loadingLoadVentas else tabla"
              class="h-[50vh] mx-auto flex flex-col items-center justify-center">
              <img alt="survived" src="https://concepthousewares.co.uk/assets/images/empty_cart.png" tuiSlot="top"
                class="object-contain w-56 h-56 text-center" />
              <h2 class="text-xl text-center">Aun no cuentas con ventas</h2>
              <p class="text-md text-center">Empieza hacer tu primera venta</p>
            </div>

            <ng-template #tabla>
              <search tuiSearch class="pb-4">
                <!-- Rango de fechas responsive -->
                <div class="mb-4 w-full">
                  <tui-input-date-range (ngModelChange)="onRangeChange($event)" [maxLength]="maxLength"
                    [ngModel]="range" class="w-full">
                    Range
                  </tui-input-date-range>
                </div>

                <form [formGroup]="form" (submit)="onSubmitSearch()">
                  <!-- Fieldset con grid responsive -->
                  <fieldset tuiTextfieldSize="s"
                    class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-3 mb-4">

                    <tui-textfield iconStart="@tui.search" class="w-full">
                      <input tuiTheme="ligth" formControlName="nombre_cliente" placeholder="Buscar nombre cliente"
                        tuiTextfield />
                    </tui-textfield>

                    <tui-select class="w-full" formControlName="metodo_pago">
                      Metodo de Pago
                      <select placeholder="Metodo pago" tuiSelect [items]="metodos_pago"></select>
                    </tui-select>

                    <tui-select class="w-full" formControlName="tipo_comprobante">
                      Tipo Comprobante
                      <select placeholder="Comprobante" tuiSelect [items]="tipoComprobantes"></select>
                    </tui-select>

                    <tui-textfield iconStart="@tui.search" class="w-full">
                      <input tuiTheme="ligth" formControlName="numero_comprobante" placeholder="Numero Comprobante"
                        tuiTextfield />
                    </tui-textfield>

                    <tui-textfield iconStart="@tui.search" class="w-full">
                      <input tuiTheme="ligth" formControlName="numero_documento_cliente" placeholder="Dni o Ruc"
                        tuiTextfield />
                    </tui-textfield>

                    <button size="s" appearance="textfield" tuiButton type="submit" (click)="onSubmitSearch()"
                      class="w-full">
                      Buscar
                    </button>
                  </fieldset>

                  <!-- Fieldset de resultados -->
                  <fieldset class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
                    <div class="text-sm sm:text-base">
                      Resultados: {{((ventasState$ | async)?.count )}}
                    </div>

                    <button appearance="flat-grayscale" iconStart="@tui.rotate-cw" size="xs" tuiButton type="reset"
                      (click)="clearSearch()" class="w-full sm:w-auto">
                      Limpiar {{ count() ? '(' + count() + ')' : '' }}
                    </button>
                  </fieldset>
                </form>
              </search>
              <tui-loader [overlay]="true" [showLoader]="!!(ventasState$ | async)?.loadingSearch">

                <!-- Contenedor principal -->
                <div
                  *ngIf="((ventasState$ | async)?.search_ventas_found) === '' || ((ventasState$ | async)?.search_ventas_found === 'ventas_found')">

                  <!-- Vista de CARDS para móviles -->
                  <div class="block lg:hidden space-y-3 px-2">
                    <div
                      *ngFor="let venta of ((ventasState$ | async)?.ventas_search?.length ? (ventasState$ | async)?.ventas_search : (ventasState$ | async)?.ventas)"
                      class="bg-white dark:bg-neutral-800 rounded-lg shadow-md p-3 border border-neutral-200 dark:border-neutral-700">

                      <!-- Header con ID y Estado -->
                      <div
                        class="flex items-center justify-between mb-3 pb-3 border-b border-neutral-200 dark:border-neutral-700">
                        <div class="flex items-center gap-2">
                          <span class="text-xs font-semibold text-neutral-500 dark:text-neutral-400">Venta #</span>
                          <span class="text-lg font-bold text-neutral-900 dark:text-white">{{venta.id}}</span>
                        </div>

                        <tui-badge [appearance]="venta.estado === 'ANULADA' ? 'error' : 
              venta.estado === 'Completada' ? 'positive' : 
              venta.estado === 'En Espera Sunat' ? 'warning' : 'neutral'" tuiStatus size="s" class="text-xs">
                          {{ venta.estado }}
                        </tui-badge>
                      </div>

                      <!-- Comprobante -->
                      <div class="mb-3">
                        <div class="text-xs text-neutral-500 dark:text-neutral-400 mb-1">Comprobante</div>
                        <tui-badge *ngIf="venta.comprobante" size="l" iconStart="@tui.ticket-check"
                          [appearance]="venta.tipo_comprobante === 'Boleta' ? 'positive' : 'info'" class="inline-flex">
                          {{ venta.tipo_comprobante }} {{ venta.comprobante.serie}} - {{venta.comprobante.correlativo}}
                        </tui-badge>
                        <span *ngIf="!venta.comprobante">SIN COMPROBANTE</span>
                      </div>

                      <!-- Productos vendidos -->
                      <div class="mb-3">
                        <div class="text-xs text-neutral-500 dark:text-neutral-400 mb-2">Productos</div>
                        <div class="flex flex-wrap gap-1">
                          <tui-chip *ngFor="let productos of venta.productos" size="xs" class="text-xs">
                            {{ productos.producto_nombre }}
                          </tui-chip>
                        </div>
                      </div>

                      <!-- Información adicional (columnas dinámicas) -->
                      <div class="grid grid-cols-2 gap-2 mb-3" *ngIf="allColumns.length > 0">
                        <div *ngFor="let column of allColumns" class="text-xs">
                          <span class="text-neutral-500 dark:text-neutral-400 block">{{ column.label }}:</span>
                          <span class="text-neutral-800 dark:text-neutral-200 font-medium">
                            {{ getVentaValue(venta, column.key) }}
                          </span>
                        </div>
                      </div>

                      <div class="grid grid-cols-2 gap-2 mb-3">
                        <div class="text-xs">
                          <span class="text-neutral-500 dark:text-neutral-400 block">Hora:</span>
                          <span class="text-neutral-800 dark:text-neutral-200 font-medium">
                            <span> {{ formatoHora12(venta.fecha_hora)}}</span>
                          </span>
                        </div>
                      </div>


                      <div class="grid grid-cols-2 gap-2 mb-3">
                        <div class="text-xs">
                          <span class="text-neutral-500 dark:text-neutral-400 block">Fecha Corta:</span>
                          <span class="text-neutral-800 dark:text-neutral-200 font-medium">
                            {{ formatoCorto(venta.fecha_realizacion || venta.fecha_hora) }}
                          </span>
                        </div>
                      </div>


                      <!-- Total y acción -->
                      <div
                        class="flex items-center justify-between pt-3 border-t border-neutral-200 dark:border-neutral-700">
                        <div>
                          <div class="text-xs text-neutral-500 dark:text-neutral-400">Total</div>
                          <p class="text-3xl font-bold text-neutral-900 dark:text-white">
                            S/. {{venta.total}}
                          </p>
                        </div>

                        <button appearance="primary-grayscale" (click)="showDialogVentaDetail(venta)" iconStart="@tui.wallet-cards"
                          tuiButton type="button" size="s" class="text-xs">
                          Ver Detalles
                        </button>
                      </div>
                    </div>
                  </div>

                  <!-- Vista de LISTA COMPACTA para desktop -->
                  <div class="hidden lg:block -mx-4 px-4 sm:mx-0 sm:px-0 space-y-2">
                    <div
                      *ngFor="let venta of ((ventasState$ | async)?.ventas_search?.length ? (ventasState$ | async)?.ventas_search : (ventasState$ | async)?.ventas)"
                      class="relative overflow-hidden rounded-2xl 
              bg-white dark:bg-neutral-800
              p-4 
              border border-neutral-200 dark:border-neutral-700 
              hover:shadow-md transition-all duration-300">

                      <!-- LISTA COMPACTA -->
                      <div class="flex items-center justify-between gap-4">

                        <!-- ICONO Y INFO PRINCIPAL -->
                        <div class="flex items-center gap-4 flex-1 min-w-0">
                          <div class="w-12 h-12 rounded-xl bg-neutral-100 dark:bg-neutral-800 
                    flex items-center justify-center shadow-sm flex-shrink-0">
                            <span class="text-lg font-bold text-neutral-700 dark:text-neutral-300">#</span>
                          </div>

                          <div class="flex-1 min-w-0">
                            <!-- Número de venta -->
                            <div class="flex items-center gap-2 mb-1">
                              <span class="text-base font-extrabold text-neutral-900 dark:text-white">
                                <ng-container *ngIf="venta.comprobante">
                                  {{venta.comprobante.serie}}-{{venta.comprobante.correlativo}}
                                </ng-container>
                                <ng-container *ngIf="!venta.comprobante">
                                  Venta #{{venta.id}}
                                </ng-container>
                              </span>
                            </div>

                            <!-- Información secundaria -->
                            <div
                              class="flex items-center gap-3 flex-wrap text-xs text-neutral-500 dark:text-neutral-400">
                              <!-- FECHA -->
                              <span class="flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                                  </path>
                                </svg>
                                {{ formatoCorto(venta.fecha_hora) }}
                              </span>

                              <!-- HORA -->
                              <span class="flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                {{ formatoHora12(venta.fecha_hora) }}
                              </span>

                              <!-- TIPO COMPROBANTE -->
                              <tui-badge size="m" tuiStatus iconStart="@tui.ticket-check" 
                                [appearance]="venta.tipo_comprobante === 'Boleta' ? 'positive' : 'info'"
                                class="whitespace-nowrap">
                                {{ venta.tipo_comprobante }}
                              </tui-badge>
                            </div>
                          </div>
                        </div>

                        <!-- ESTADO, TOTAL Y ACCIONES -->
                        <div class="flex items-center gap-4 flex-shrink-0">
                          <!-- ESTADO -->
                          <tui-badge [appearance]="venta.estado === 'ANULADA' ? 'error' :
                    venta.estado === 'Completada' ? 'positive' :
                    venta.estado === 'En Espera Sunat' ? 'warning' : 'neutral'" tuiStatus size="m"
                            class="text-sm font-semibold whitespace-nowrap">
                            {{ venta.estado }}
                          </tui-badge>

                          <!-- TICKET -->
                          <a *ngIf="venta.comprobante" [href]="stripDomain(venta.comprobante.ticket_url)"
                            target="_blank"
                            class="flex flex-col items-center justify-center gap-1 px-3 py-2 bg-neutral-100 dark:bg-neutral-800 hover:bg-neutral-200 dark:hover:bg-neutral-700 rounded-lg transition-colors">
                            <svg class="w-4 h-4 text-neutral-700 dark:text-neutral-300" fill="none"
                              stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z">
                              </path>
                            </svg>
                            <span class="text-xs font-medium text-neutral-700 dark:text-neutral-300">Ticket</span>
                          </a>
                          <div *ngIf="!venta.comprobante"
                            class="flex flex-col items-center justify-center gap-1 px-3 py-2 bg-neutral-100 dark:bg-neutral-800 rounded-lg opacity-50">
                            <svg class="w-4 h-4 text-neutral-700 dark:text-neutral-300" fill="none"
                              stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z">
                              </path>
                            </svg>
                            <span class="text-xs font-medium text-neutral-700 dark:text-neutral-300">Sin Ticket</span>
                          </div>

                          <!-- TOTAL -->
                          <div class="text-right min-w-[100px]">
                            <p class="text-xs text-neutral-500 dark:text-neutral-400 uppercase">Total</p>
                            <p class="text-lg font-extrabold text-neutral-900 dark:text-white whitespace-nowrap">
                              S/. {{venta.total}}
                            </p>
                          </div>

                          <!-- BOTÓN DETALLES -->
                          <button tuiButton size="s" appearance="primary-grayscale" iconStart="@tui.wallet-cards"
                            (click)="showDialogVentaDetail(venta)"
                            class="text-xs font-semibold shadow hover:shadow-md transition whitespace-nowrap">
                            Detalles
                          </button>
                        </div>

                      </div>

                    </div>
                  </div>
                </div>

                <!-- Estado de búsqueda vacía -->
                <tui-block-status *ngIf="((ventasState$ | async)?.search_ventas_found) === 'ventas_not_found'" size="m"
                  class="m-auto px-4">
                  <img alt="survived"
                    src="https://res.cloudinary.com/ddksrkond/image/upload/v1743382501/APP%20INVENTARIO/undraw_no-data_ig65_k666oz.svg"
                    tuiSlot="top" class="max-w-[200px] sm:max-w-full mx-auto" />
                  <h4 class="text-center text-sm sm:text-base">Ventas no encontradas</h4>
                  <span class="text-center text-xs sm:text-sm">No coincidimos con ninguna venta</span>
                </tui-block-status>

                <!-- Paginación responsive -->
                <div class="pt-4 flex justify-center px-2"
                  *ngIf="((ventasState$ | async)?.search_ventas_found) === 'ventas_found' || ((ventasState$ | async)?.search_ventas_found) === ''">
                  <tui-pagination [index]="(ventasState$ | async)?.index_page"
                    [length]="(ventasState$ | async)?.length_pages" (indexChange)="goToPage($event)"
                    class="w-full overflow-x-auto" />
                </div>
              </tui-loader>
            </ng-template>
          </section>
        </div>
      </ng-container>


      <!-- TAB: VENTAS HOY -->
      <ng-container *ngIf="activeTab === 'ventas-hoy'">
        <!-- CONTENIDO: Ventas del día -->
        <div>
                    <h2 class="text-xl font-bold mb-3">Todas las ventas realizadas hoy</h2>
<p class="text-xs italic pb-3"> * Todavia en pruebas,valores inventados</p>
                    <div>
                      <div class="flex gap-4 flex-wrap">
  
  <!-- FACTURACIÓN TOTAL DE HOY -->
  <div class="flex-1 min-w-[250px] rounded-2xl bg-gradient-to-br from-green-400 to-green-500 p-5 shadow-lg">
    <div class="flex items-start justify-between mb-3">
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 rounded-full bg-black/20 flex items-center justify-center">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        </div>
      </div>
      <div class="px-2 py-1 rounded-full bg-black/20 flex items-center gap-1">
        <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M12 7a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0V8.414l-4.293 4.293a1 1 0 01-1.414 0L8 10.414l-4.293 4.293a1 1 0 01-1.414-1.414l5-5a1 1 0 011.414 0L11 10.586 14.586 7H12z" clip-rule="evenodd"></path>
        </svg>
        <span class="text-xs font-bold text-white">8.0%</span>
      </div>
    </div>
    <div>
      <p class="text-sm font-medium text-white/80 mb-1">Facturación Total de Hoy </p>
      <p class="text-3xl font-extrabold text-white">S/. 14,823.20</p>
    </div>
  </div>

  <!-- TOTAL DE DESCUENTOS -->
  <div class="flex-1 min-w-[250px] rounded-2xl bg-gradient-to-br from-purple-400 to-purple-500 p-5 shadow-lg">
    <div class="flex items-start justify-between mb-3">
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 rounded-full bg-black/20 flex items-center justify-center">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
          </svg>
        </div>
      </div>
      <div class="px-2 py-1 rounded-full bg-black/20 flex items-center gap-1">
        <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
        </svg>
        <span class="text-xs font-bold text-white">2.0%</span>
      </div>
    </div>
    <div>
      <p class="text-sm font-medium text-white/80 mb-1">Total de Descuentos</p>
      <p class="text-3xl font-extrabold text-white">S/. 2,498.80</p>
    </div>
  </div>

  <!-- ESTIMACIÓN DE GANANCIA -->
  <div class="flex-1 min-w-[250px] rounded-2xl bg-gradient-to-br from-neutral-700 to-neutral-800 p-5 shadow-lg">
    <div class="flex items-start justify-between mb-3">
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 rounded-full bg-white/10 flex items-center justify-center">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
          </svg>
        </div>
      </div>
    </div>
    <div>
      <p class="text-sm font-medium text-white/60 mb-1">Estimación de Ganancia de Hoy</p>
      <p class="text-3xl font-extrabold text-white">S/. 1,482.50</p>
    </div>
  </div>

</div>
                    </div>
          <app-todaysalestable></app-todaysalestable>
        </div>
      </ng-container>


      <!-- TAB: VER ÚLTIMA VENTA -->
      <ng-container *ngIf="activeTab === 'ultima-venta'">
        <!-- CONTENIDO: Última venta realizada -->
        <div>
          <h2 class="text-xl font-bold mb-3">Última venta realizada</h2> <div>
          <app-todaysale></app-todaysale>
        </div>
        </div>
      </ng-container>


      <!-- TAB: VENTAS ANULADAS HOY -->
      <ng-container *ngIf="activeTab === 'anuladas-hoy'">
        <!-- CONTENIDO: Anuladas del día -->
        <div>
          <h2 class="text-xl font-bold mb-3">Ventas Anuladas Hoy</h2>
                    <app-canceledsales></app-canceledsales>
        </div>
      </ng-container>


      <!-- TAB: PRODUCTOS MÁS VENDIDOS HOY -->
      <ng-container *ngIf="activeTab === 'top-productos-hoy'">
        <!-- CONTENIDO: Top productos del día -->
        <div>
          <h2 class="text-xl font-bold mb-3">Productos más vendidos Hoy</h2>
          <app-mostsalesproducts></app-mostsalesproducts>
        </div>
      </ng-container>

    </div>
  </div>
</main>